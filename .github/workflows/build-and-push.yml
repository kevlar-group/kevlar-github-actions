name: Build and Push Job
on:
  workflow_call:
    inputs:
      registry:
        description: 'Docker registry URL'
        required: false
        type: string
        default: 'docker.io'
      image-name:
        description: 'Docker image name'
        required: true
        type: string
      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
    secrets:
      dockerhub-username:
        required: true
      dockerhub-token: 
        required: true
        

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Docker
      uses: ./.github/workflows/steps/setup-docker.yml

    - name: Docker Login
      uses: ./.github/workflows/steps/docker-login.yml
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and Push Docker Image
      uses: ./.github/workflows/steps/build-push-docker.yml
      with:
        registry: ${{ inputs.registry }}
        image-name: ${{ inputs.image-name }}
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        dockerfile: ${{ inputs.dockerfile }} 